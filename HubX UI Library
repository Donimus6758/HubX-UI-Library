-- HubX UI Library v2_tabsfix
-- Based on your v2 (dropdown fix) + scrollable Tabs sidebar

local HubX = {}

local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

HubX._gui = nil
HubX._notificationsFrame = nil
HubX._popupLayer = nil

HubX.Theme = {
    Background = Color3.fromRGB(17, 17, 20),
    BackgroundAlt = Color3.fromRGB(22, 22, 26),
    Topbar = Color3.fromRGB(24, 24, 30),
    Accent = Color3.fromRGB(0, 153, 255),
    AccentDark = Color3.fromRGB(0, 110, 200),
    Element = Color3.fromRGB(26, 26, 32),
    ElementOutline = Color3.fromRGB(45, 45, 58),
    Text = Color3.fromRGB(235, 235, 245),
    SubText = Color3.fromRGB(150, 155, 170),
    Placeholder = Color3.fromRGB(110, 115, 130),
    ToggleOn = Color3.fromRGB(0, 153, 255),
    ToggleOff = Color3.fromRGB(55, 59, 76),
    SliderTrack = Color3.fromRGB(40, 43, 58),
    SliderFill = Color3.fromRGB(0, 153, 255),
    Dropdown = Color3.fromRGB(30, 32, 40),
    Notification = Color3.fromRGB(24, 24, 30),
}

local function createGui()
    if HubX._gui and HubX._gui.Parent then return end

    local parent
    pcall(function()
        parent = game:GetService("CoreGui")
    end)
    if not parent or not parent:IsDescendantOf(game) then
        local plr = Players.LocalPlayer
        parent = plr:WaitForChild("PlayerGui")
    end

    local gui = Instance.new("ScreenGui")
    gui.Name = "HubX_UI"
    gui.ResetOnSpawn = false
    gui.IgnoreGuiInset = true
    gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    gui.Parent = parent

    local notiHolder = Instance.new("Frame")
    notiHolder.Name = "Notifications"
    notiHolder.AnchorPoint = Vector2.new(1, 1)
    notiHolder.Position = UDim2.new(1, -20, 1, -20)
    notiHolder.Size = UDim2.new(0, 300, 0, 0)
    notiHolder.BackgroundTransparency = 1
    notiHolder.ZIndex = 40
    notiHolder.Parent = gui

    local layout = Instance.new("UIListLayout")
    layout.HorizontalAlignment = Enum.HorizontalAlignment.Right
    layout.VerticalAlignment = Enum.VerticalAlignment.Bottom
    layout.SortOrder = Enum.SortOrder.LayoutOrder
    layout.Padding = UDim.new(0, 6)
    layout.Parent = notiHolder

    local popupLayer = Instance.new("Frame")
    popupLayer.Name = "PopupLayer"
    popupLayer.BackgroundTransparency = 1
    popupLayer.Size = UDim2.new(1, 0, 1, 0)
    popupLayer.ZIndex = 30
    popupLayer.Parent = gui

    HubX._gui = gui
    HubX._notificationsFrame = notiHolder
    HubX._popupLayer = popupLayer
end

local function makeDraggable(frame, dragHandle)
    dragHandle = dragHandle or frame
    local dragging = false
    local dragStart
    local startPos

    local function update(input)
        local delta = input.Position - dragStart
        frame.Position = UDim2.new(
            startPos.X.Scale,
            startPos.X.Offset + delta.X,
            startPos.Y.Scale,
            startPos.Y.Offset + delta.Y
        )
    end

    dragHandle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1
        or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position

            local moveConn
            local releaseConn

            moveConn = UIS.InputChanged:Connect(function(changed)
                if changed == input and dragging then
                    update(changed)
                end
            end)

            releaseConn = input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                    if moveConn then moveConn:Disconnect() end
                    if releaseConn then releaseConn:Disconnect() end
                end
            end)
        end
    end)
end

local WindowMethods = {}
WindowMethods.__index = WindowMethods

local TabMethods = {}
TabMethods.__index = TabMethods

local function createElementBase(tab, height)
    local theme = HubX.Theme
    local container = tab._elementsContainer

    local item = Instance.new("Frame")
    item.Name = "Element"
    item.Size = UDim2.new(1, 0, 0, height or 42)
    item.BackgroundColor3 = theme.Element
    item.BorderSizePixel = 0
    item.ZIndex = 5
    item.Parent = container

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = item

    local outline = Instance.new("UIStroke")
    outline.Thickness = 1
    outline.Color = theme.ElementOutline
    outline.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    outline.Parent = item

    local padding = Instance.new("UIPadding")
    padding.PaddingLeft = UDim.new(0, 10)
    padding.PaddingRight = UDim.new(0, 10)
    padding.Parent = item

    return item
end

function HubX:Notify(title, text, duration)
    createGui()
    local theme = HubX.Theme
    duration = duration or 4

    local holder = HubX._notificationsFrame
    if not holder then return end

    local frame = Instance.new("Frame")
    frame.Name = "Notification"
    frame.Size = UDim2.new(1, 0, 0, 70)
    frame.BackgroundColor3 = theme.Notification
    frame.BackgroundTransparency = 0
    frame.BorderSizePixel = 0
    frame.ZIndex = 41
    frame.Parent = holder

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = frame

    local stroke = Instance.new("UIStroke")
    stroke.Color = theme.ElementOutline
    stroke.Thickness = 1
    stroke.Parent = frame

    local padding = Instance.new("UIPadding")
    padding.PaddingTop = UDim.new(0, 8)
    padding.PaddingBottom = UDim.new(0, 8)
    padding.PaddingLeft = UDim.new(0, 10)
    padding.PaddingRight = UDim.new(0, 10)
    padding.Parent = frame

    local titleLabel = Instance.new("TextLabel")
    titleLabel.Name = "Title"
    titleLabel.BackgroundTransparency = 1
    titleLabel.Size = UDim2.new(1, 0, 0, 22)
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.Text = title or "HubX"
    titleLabel.TextColor3 = theme.Text
    titleLabel.TextSize = 14
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.ZIndex = 42
    titleLabel.Parent = frame

    local bodyLabel = Instance.new("TextLabel")
    bodyLabel.Name = "Body"
    bodyLabel.BackgroundTransparency = 1
    bodyLabel.Position = UDim2.new(0, 0, 0, 22)
    bodyLabel.Size = UDim2.new(1, 0, 0, 30)
    bodyLabel.Font = Enum.Font.Gotham
    bodyLabel.TextWrapped = true
    bodyLabel.TextYAlignment = Enum.TextYAlignment.Top
    bodyLabel.Text = text or ""
    bodyLabel.TextColor3 = theme.SubText
    bodyLabel.TextSize = 13
    bodyLabel.TextXAlignment = Enum.TextXAlignment.Left
    bodyLabel.ZIndex = 42
    bodyLabel.Parent = frame

    frame.BackgroundTransparency = 1
    titleLabel.TextTransparency = 1
    bodyLabel.TextTransparency = 1

    TweenService:Create(frame, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
        BackgroundTransparency = 0
    }):Play()
    TweenService:Create(titleLabel, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
        TextTransparency = 0
    }):Play()
    TweenService:Create(bodyLabel, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
        TextTransparency = 0
    }):Play()

    task.spawn(function()
        task.wait(duration)
        local tweenOut = TweenService:Create(frame, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
            BackgroundTransparency = 1
        })
        local tweenOutText1 = TweenService:Create(titleLabel, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
            TextTransparency = 1
        })
        local tweenOutText2 = TweenService:Create(bodyLabel, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
            TextTransparency = 1
        })
        tweenOut:Play()
        tweenOutText1:Play()
        tweenOutText2:Play()
        tweenOut.Completed:Wait()
        frame:Destroy()
    end)
end

function HubX:CreateWindow(config)
    createGui()
    config = config or {}
    local theme = HubX.Theme

    local title = config.Title or "HubX"
    local subtitle = config.Subtitle or ""
    local size = config.Size or UDim2.new(0, 520, 0, 320)

    local windowFrame = Instance.new("Frame")
    windowFrame.Name = "HubXWindow"
    windowFrame.Size = size
    windowFrame.Position = UDim2.new(0.5, -size.X.Offset/2, 0.5, -size.Y.Offset/2)
    windowFrame.BackgroundColor3 = theme.Background
    windowFrame.BorderSizePixel = 0
    windowFrame.ClipsDescendants = true
    windowFrame.ZIndex = 5
    windowFrame.Parent = HubX._gui

    local shadow = Instance.new("ImageLabel")
    shadow.Name = "Shadow"
    shadow.AnchorPoint = Vector2.new(0.5, 0.5)
    shadow.Position = UDim2.new(0.5, 0, 0.5, 6)
    shadow.Size = UDim2.new(1, 24, 1, 24)
    shadow.BackgroundTransparency = 1
    shadow.Image = "rbxassetid://5028857084"
    shadow.ImageColor3 = Color3.fromRGB(0, 0, 0)
    shadow.ImageTransparency = 0.35
    shadow.ScaleType = Enum.ScaleType.Slice
    shadow.SliceCenter = Rect.new(24, 24, 276, 276)
    shadow.ZIndex = 4
    shadow.Parent = windowFrame

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = windowFrame

    local topbar = Instance.new("Frame")
    topbar.Name = "Topbar"
    topbar.Size = UDim2.new(1, 0, 0, 36)
    topbar.BackgroundColor3 = theme.Topbar
    topbar.BorderSizePixel = 0
    topbar.ZIndex = 6
    topbar.Parent = windowFrame

    local topCorner = Instance.new("UICorner")
    topCorner.CornerRadius = UDim.new(0, 8)
    topCorner.Parent = topbar

    local topMask = Instance.new("Frame")
    topMask.Name = "TopMask"
    topMask.AnchorPoint = Vector2.new(0.5, 1)
    topMask.Position = UDim2.new(0.5, 0, 1, 0)
    topMask.Size = UDim2.new(1, 0, 0, 8)
    topMask.BackgroundColor3 = theme.Topbar
    topMask.BorderSizePixel = 0
    topMask.ZIndex = 6
    topMask.Parent = topbar

    local titleLabel = Instance.new("TextLabel")
    titleLabel.Name = "Title"
    titleLabel.BackgroundTransparency = 1
    titleLabel.Position = UDim2.new(0, 12, 0, 2)
    titleLabel.Size = UDim2.new(1, -80, 0, 18)
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.Text = title
    titleLabel.TextSize = 16
    titleLabel.TextColor3 = theme.Text
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.ZIndex = 7
    titleLabel.Parent = topbar

    local subtitleLabel = Instance.new("TextLabel")
    subtitleLabel.Name = "Subtitle"
    subtitleLabel.BackgroundTransparency = 1
    subtitleLabel.Position = UDim2.new(0, 12, 0, 18)
    subtitleLabel.Size = UDim2.new(1, -80, 0, 16)
    subtitleLabel.Font = Enum.Font.Gotham
    subtitleLabel.Text = subtitle
    subtitleLabel.TextSize = 13
    subtitleLabel.TextColor3 = theme.SubText
    subtitleLabel.TextXAlignment = Enum.TextXAlignment.Left
    subtitleLabel.ZIndex = 7
    subtitleLabel.Parent = topbar

    local closeButton = Instance.new("TextButton")
    closeButton.Name = "Close"
    closeButton.AnchorPoint = Vector2.new(1, 0.5)
    closeButton.Position = UDim2.new(1, -10, 0.5, 0)
    closeButton.Size = UDim2.new(0, 20, 0, 20)
    closeButton.BackgroundColor3 = Color3.fromRGB(45, 45, 60)
    closeButton.AutoButtonColor = false
    closeButton.Text = "×"
    closeButton.Font = Enum.Font.GothamBold
    closeButton.TextSize = 16
    closeButton.TextColor3 = theme.SubText
    closeButton.ZIndex = 7
    closeButton.Parent = topbar

    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(1, 0)
    closeCorner.Parent = closeButton

    closeButton.MouseEnter:Connect(function()
        TweenService:Create(closeButton, TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
            BackgroundColor3 = Color3.fromRGB(80, 40, 40),
            TextColor3 = Color3.fromRGB(255, 255, 255)
        }):Play()
    end)

    closeButton.MouseLeave:Connect(function()
        TweenService:Create(closeButton, TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
            BackgroundColor3 = Color3.fromRGB(45, 45, 60),
            TextColor3 = theme.SubText
        }):Play()
    end)

    closeButton.MouseButton1Click:Connect(function()
        local tween = TweenService:Create(windowFrame, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
            BackgroundTransparency = 1
        })
        tween:Play()
        tween.Completed:Wait()
        windowFrame:Destroy()
    end)

    local sidebar = Instance.new("Frame")
    sidebar.Name = "Sidebar"
    sidebar.Position = UDim2.new(0, 0, 0, 36)
    sidebar.Size = UDim2.new(0, 150, 1, -36)
    sidebar.BackgroundColor3 = theme.BackgroundAlt
    sidebar.BorderSizePixel = 0
    sidebar.ZIndex = 5
    sidebar.Parent = windowFrame

    local sidebarCorner = Instance.new("UICorner")
    sidebarCorner.CornerRadius = UDim.new(0, 8)
    sidebarCorner.Parent = sidebar

    local sidebarPadding = Instance.new("UIPadding")
    sidebarPadding.PaddingTop = UDim.new(0, 10)
    sidebarPadding.PaddingBottom = UDim.new(0, 10)
    sidebarPadding.PaddingLeft = UDim.new(0, 10)
    sidebarPadding.PaddingRight = UDim.new(0, 10)
    sidebarPadding.Parent = sidebar

    -- scrollable tab list
    local tabScroll = Instance.new("ScrollingFrame")
    tabScroll.Name = "TabList"
    tabScroll.BackgroundTransparency = 1
    tabScroll.BorderSizePixel = 0
    tabScroll.Size = UDim2.new(1, 0, 1, 0)
    tabScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
    tabScroll.ScrollBarThickness = 3
    tabScroll.ScrollBarImageColor3 = Color3.fromRGB(80, 84, 98)
    tabScroll.VerticalScrollBarInset = Enum.ScrollBarInset.Always
    tabScroll.ZIndex = 6
    tabScroll.Parent = sidebar

    local tabLayout = Instance.new("UIListLayout")
    tabLayout.SortOrder = Enum.SortOrder.LayoutOrder
    tabLayout.Padding = UDim.new(0, 6)
    tabLayout.Parent = tabScroll

    tabLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        local contentSize = tabLayout.AbsoluteContentSize.Y
        tabScroll.CanvasSize = UDim2.new(0, 0, 0, contentSize + 10)
    end)

    local content = Instance.new("Frame")
    content.Name = "Content"
    content.Position = UDim2.new(0, 150, 0, 36)
    content.Size = UDim2.new(1, -150, 1, -36)
    content.BackgroundColor3 = theme.Background
    content.BorderSizePixel = 0
    content.ZIndex = 5
    content.Parent = windowFrame

    local contentCorner = Instance.new("UICorner")
    contentCorner.CornerRadius = UDim.new(0, 8)
    contentCorner.Parent = content

    local contentPadding = Instance.new("UIPadding")
    contentPadding.PaddingTop = UDim.new(0, 12)
    contentPadding.PaddingBottom = UDim.new(0, 12)
    contentPadding.PaddingLeft = UDim.new(0, 12)
    contentPadding.PaddingRight = UDim.new(0, 12)
    contentPadding.Parent = content

    windowFrame.BackgroundTransparency = 1
    TweenService:Create(windowFrame, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
        BackgroundTransparency = 0
    }):Play()

    makeDraggable(windowFrame, topbar)

    local window = {
        _frame = windowFrame,
        _tabList = tabScroll,
        _content = content,
        _tabs = {},
        _activeTab = nil,
    }

    setmetatable(window, WindowMethods)
    return window
end

function WindowMethods:_setActiveTab(tab)
    if self._activeTab == tab then return end

    for _, t in ipairs(self._tabs) do
        if t._button then
            local bgColor = (t == tab) and HubX.Theme.AccentDark or HubX.Theme.Element
            local textColor = (t == tab) and Color3.fromRGB(255, 255, 255) or HubX.Theme.SubText
            TweenService:Create(t._button, TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
                BackgroundColor3 = bgColor
            }):Play()
            TweenService:Create(t._buttonLabel, TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
                TextColor3 = textColor
            }):Play()
        end
        if t._page then
            t._page.Visible = (t == tab)
        end
    end

    self._activeTab = tab
end

function WindowMethods:CreateTab(name)
    local theme = HubX.Theme
    name = name or "Tab"

    local button = Instance.new("TextButton")
    button.Name = name
    button.Size = UDim2.new(1, 0, 0, 32)
    button.BackgroundColor3 = theme.Element
    button.AutoButtonColor = false
    button.Text = ""
    button.ZIndex = 7
    button.Parent = self._tabList

    local buttonCorner = Instance.new("UICorner")
    buttonCorner.CornerRadius = UDim.new(0, 6)
    buttonCorner.Parent = button

    local label = Instance.new("TextLabel")
    label.Name = "Label"
    label.BackgroundTransparency = 1
    label.Size = UDim2.new(1, 0, 1, 0)
    label.Font = Enum.Font.Gotham
    label.Text = name
    label.TextSize = 14
    label.TextColor3 = theme.SubText
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.TextYAlignment = Enum.TextYAlignment.Center
    label.ZIndex = 8
    label.Parent = button

    local padding = Instance.new("UIPadding")
    padding.PaddingLeft = UDim.new(0, 10)
    padding.Parent = button

    button.MouseEnter:Connect(function()
        if self._activeTab and self._activeTab._button == button then return end
        TweenService:Create(button, TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
            BackgroundColor3 = theme.ElementOutline
        }):Play()
    end)

    button.MouseLeave:Connect(function()
        if self._activeTab and self._activeTab._button == button then return end
        TweenService:Create(button, TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
            BackgroundColor3 = theme.Element
        }):Play()
    end)

    local page = Instance.new("ScrollingFrame")
    page.Name = name .. "_Page"
    page.Size = UDim2.new(1, 0, 1, 0)
    page.BackgroundTransparency = 1
    page.ScrollBarThickness = 4
    page.CanvasSize = UDim2.new(0, 0, 0, 0)
    page.ScrollBarImageColor3 = Color3.fromRGB(80, 84, 98)
    page.Visible = false
    page.ZIndex = 5
    page.Parent = self._content

    local pageLayout = Instance.new("UIListLayout")
    pageLayout.SortOrder = Enum.SortOrder.LayoutOrder
    pageLayout.Padding = UDim.new(0, 8)
    pageLayout.Parent = page

    local pagePadding = Instance.new("UIPadding")
    pagePadding.PaddingTop = UDim.new(0, 2)
    pagePadding.PaddingBottom = UDim.new(0, 2)
    pagePadding.Parent = page

    pageLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        page.CanvasSize = UDim2.new(0, 0, 0, pageLayout.AbsoluteContentSize.Y + 8)
    end)

    local tab = {
        _window = self,
        _button = button,
        _buttonLabel = label,
        _page = page,
        _elementsContainer = page
    }

    setmetatable(tab, TabMethods)
    table.insert(self._tabs, tab)

    button.MouseButton1Click:Connect(function()
        self:_setActiveTab(tab)
    end)

    if not self._activeTab then
        self:_setActiveTab(tab)
    end

    return tab
end

-- BUTTON
function TabMethods:CreateButton(opts)
    opts = opts or {}
    local text = opts.Text or "Button"
    local callback = opts.Callback or function() end
    local theme = HubX.Theme

    local item = createElementBase(self, 40)

    local label = Instance.new("TextLabel")
    label.Name = "Label"
    label.BackgroundTransparency = 1
    label.Size = UDim2.new(1, -110, 1, 0)
    label.Font = Enum.Font.Gotham
    label.Text = text
    label.TextSize = 14
    label.TextColor3 = theme.Text
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.ZIndex = 6
    label.Parent = item

    local btn = Instance.new("TextButton")
    btn.Name = "Button"
    btn.AnchorPoint = Vector2.new(1, 0.5)
    btn.Position = UDim2.new(1, -4, 0.5, 0)
    btn.Size = UDim2.new(0, 88, 0, 26)
    btn.BackgroundColor3 = theme.Accent
    btn.AutoButtonColor = false
    btn.Text = "Execute"
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 13
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.ZIndex = 6
    btn.Parent = item

    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = UDim.new(0, 6)
    btnCorner.Parent = btn

    btn.MouseEnter:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
            BackgroundColor3 = theme.AccentDark
        }):Play()
    end)

    btn.MouseLeave:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
            BackgroundColor3 = theme.Accent
        }):Play()
    end)

    btn.MouseButton1Click:Connect(function()
        task.spawn(function()
            pcall(callback)
        end)
    end)

    return {
        SetText = function(_, t)
            label.Text = t
        end
    }
end

-- TOGGLE
function TabMethods:CreateToggle(opts)
    opts = opts or {}
    local text = opts.Text or "Toggle"
    local default = opts.Default or false
    local callback = opts.Callback or function() end
    local theme = HubX.Theme

    local item = createElementBase(self, 40)

    local label = Instance.new("TextLabel")
    label.Name = "Label"
    label.BackgroundTransparency = 1
    label.Size = UDim2.new(1, -80, 1, 0)
    label.Font = Enum.Font.Gotham
    label.Text = text
    label.TextSize = 14
    label.TextColor3 = theme.Text
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.ZIndex = 6
    label.Parent = item

    local toggleBtn = Instance.new("TextButton")
    toggleBtn.Name = "Toggle"
    toggleBtn.AnchorPoint = Vector2.new(1, 0.5)
    toggleBtn.Position = UDim2.new(1, -4, 0.5, 0)
    toggleBtn.Size = UDim2.new(0, 40, 0, 20)
    toggleBtn.BackgroundColor3 = default and theme.ToggleOn or theme.ToggleOff
    toggleBtn.AutoButtonColor = false
    toggleBtn.Text = ""
    toggleBtn.ZIndex = 6
    toggleBtn.Parent = item

    local toggleCorner = Instance.new("UICorner")
    toggleCorner.CornerRadius = UDim.new(1, 0)
    toggleCorner.Parent = toggleBtn

    local knob = Instance.new("Frame")
    knob.Name = "Knob"
    knob.AnchorPoint = Vector2.new(0.5, 0.5)
    knob.Size = UDim2.new(0, 16, 0, 16)
    knob.Position = default and UDim2.new(1, -10, 0.5, 0) or UDim2.new(0, 10, 0.5, 0)
    knob.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    knob.ZIndex = 7
    knob.Parent = toggleBtn

    local knobCorner = Instance.new("UICorner")
    knobCorner.CornerRadius = UDim.new(1, 0)
    knobCorner.Parent = knob

    local state = default

    local function setState(val, fromClick)
        state = val
        local targetColor = state and theme.ToggleOn or theme.ToggleOff
        local targetPos = state and UDim2.new(1, -10, 0.5, 0) or UDim2.new(0, 10, 0.5, 0)
        TweenService:Create(toggleBtn, TweenInfo.new(0.18, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
            BackgroundColor3 = targetColor
        }):Play()
        TweenService:Create(knob, TweenInfo.new(0.18, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
            Position = targetPos
        }):Play()
        if fromClick then
            task.spawn(function()
                pcall(callback, state)
            end)
        end
    end

    toggleBtn.MouseButton1Click:Connect(function()
        setState(not state, true)
    end)

    if default then
        task.spawn(function()
            pcall(callback, state)
        end)
    end

    return {
        Set = function(_, v)
            setState(v, true)
        end,
        Get = function()
            return state
        end
    }
end

-- SLIDER (touch-friendly)
function TabMethods:CreateSlider(opts)
    opts = opts or {}
    local text = opts.Text or "Slider"
    local min = opts.Min or 0
    local max = opts.Max or 100
    local default = opts.Default
    local callback = opts.Callback or function() end
    local theme = HubX.Theme

    if max <= min then max = min + 1 end
    if default == nil then default = min end
    if default < min then default = min end
    if default > max then default = max end

    local item = createElementBase(self, 52)

    local label = Instance.new("TextLabel")
    label.Name = "Label"
    label.BackgroundTransparency = 1
    label.Size = UDim2.new(1, -40, 0, 22)
    label.Font = Enum.Font.Gotham
    label.Text = text
    label.TextSize = 14
    label.TextColor3 = theme.Text
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.ZIndex = 6
    label.Parent = item

    local valueLabel = Instance.new("TextLabel")
    valueLabel.Name = "Value"
    valueLabel.BackgroundTransparency = 1
    valueLabel.AnchorPoint = Vector2.new(1, 0)
    valueLabel.Position = UDim2.new(1, 0, 0, 0)
    valueLabel.Size = UDim2.new(0, 40, 0, 22)
    valueLabel.Font = Enum.Font.Gotham
    valueLabel.Text = tostring(default)
    valueLabel.TextSize = 13
    valueLabel.TextColor3 = theme.SubText
    valueLabel.TextXAlignment = Enum.TextXAlignment.Right
    valueLabel.ZIndex = 6
    valueLabel.Parent = item

    local track = Instance.new("Frame")
    track.Name = "Track"
    track.Position = UDim2.new(0, 0, 0, 26)
    track.Size = UDim2.new(1, 0, 0, 8)
    track.BackgroundColor3 = theme.SliderTrack
    track.BorderSizePixel = 0
    track.ZIndex = 6
    track.Parent = item

    local trackCorner = Instance.new("UICorner")
    trackCorner.CornerRadius = UDim.new(0, 999)
    trackCorner.Parent = track

    local glow = Instance.new("ImageLabel")
    glow.Name = "Glow"
    glow.BackgroundTransparency = 1
    glow.AnchorPoint = Vector2.new(0, 0.5)
    glow.Position = UDim2.new(0, 0, 0.5, 0)
    glow.Size = UDim2.new(0, 0, 1.8, 0)
    glow.Image = "rbxassetid://5028857084"
    glow.ImageColor3 = theme.SliderFill
    glow.ImageTransparency = 0.35
    glow.ScaleType = Enum.ScaleType.Slice
    glow.SliceCenter = Rect.new(24,24,276,276)
    glow.ZIndex = 5
    glow.Parent = track

    local fill = Instance.new("Frame")
    fill.Name = "Fill"
    fill.Size = UDim2.new(0, 0, 1, 0)
    fill.BackgroundColor3 = theme.SliderFill
    fill.BorderSizePixel = 0
    fill.ZIndex = 7
    fill.Parent = track

    local fillCorner = Instance.new("UICorner")
    fillCorner.CornerRadius = UDim.new(0, 999)
    fillCorner.Parent = fill

    local knobHit = Instance.new("TextButton")
    knobHit.Name = "KnobHitbox"
    knobHit.BackgroundTransparency = 1
    knobHit.Size = UDim2.new(1, 0, 3, 0)
    knobHit.Position = UDim2.new(0, 0, -1, 0)
    knobHit.Text = ""
    knobHit.ZIndex = 8
    knobHit.Parent = track

    local knob = Instance.new("Frame")
    knob.Name = "Knob"
    knob.AnchorPoint = Vector2.new(0.5, 0.5)
    knob.Size = UDim2.new(0, 14, 0, 14)
    knob.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    knob.ZIndex = 9
    knob.Parent = track

    local knobCorner = Instance.new("UICorner")
    knobCorner.CornerRadius = UDim.new(1, 0)
    knobCorner.Parent = knob

    local currentValue = default

    local function setFromPercent(p, fire)
        p = math.clamp(p, 0, 1)
        local val = min + (max - min) * p
        val = math.floor(val + 0.5)
        currentValue = val
        valueLabel.Text = tostring(val)

        local tweenTime = 0.08
        TweenService:Create(fill, TweenInfo.new(tweenTime, Enum.EasingStyle.Linear, Enum.EasingDirection.Out), {
            Size = UDim2.new(p, 0, 1, 0)
        }):Play()
        TweenService:Create(glow, TweenInfo.new(tweenTime, Enum.EasingStyle.Linear, Enum.EasingDirection.Out), {
            Size = UDim2.new(p, 6, 1.8, 6)
        }):Play()
        knob.Position = UDim2.new(p, 0, 0.5, 0)

        if fire then
            task.spawn(function()
                pcall(callback, val)
            end)
        end
    end

    local function updateFromInput(input, fire)
        local rel = (input.Position.X - track.AbsolutePosition.X) / track.AbsoluteSize.X
        setFromPercent(rel, fire)
    end

    local dragging = false

    local function beginDrag(input)
        dragging = true
        updateFromInput(input, true)
    end

    knobHit.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1
        or input.UserInputType == Enum.UserInputType.Touch then
            beginDrag(input)
        end
    end)

    knobHit.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1
        or input.UserInputType == Enum.UserInputType.Touch then
            dragging = false
        end
    end)

    UIS.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement
        or input.UserInputType == Enum.UserInputType.Touch) then
            updateFromInput(input, true)
        end
    end)

    local initialPercent = (default - min) / (max - min)
    setFromPercent(initialPercent, false)
    task.spawn(function()
        pcall(callback, currentValue)
    end)

    return {
        Set = function(_, v)
            if v < min then v = min end
            if v > max then v = max end
            local p = (v - min) / (max - min)
            setFromPercent(p, true)
        end,
        Get = function()
            return currentValue
        end
    }
end

-- TEXTBOX
function TabMethods:CreateTextbox(opts)
    opts = opts or {}
    local text = opts.Text or "Textbox"
    local placeholder = opts.Placeholder or "Enter text..."
    local default = opts.Default or ""
    local callback = opts.Callback or function() end
    local theme = HubX.Theme

    local item = createElementBase(self, 46)

    local label = Instance.new("TextLabel")
    label.Name = "Label"
    label.BackgroundTransparency = 1
    label.Size = UDim2.new(1, -160, 1, 0)
    label.Font = Enum.Font.Gotham
    label.Text = text
    label.TextSize = 14
    label.TextColor3 = theme.Text
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.ZIndex = 6
    label.Parent = item

    local box = Instance.new("TextBox")
    box.Name = "Textbox"
    box.AnchorPoint = Vector2.new(1, 0.5)
    box.Position = UDim2.new(1, -4, 0.5, 0)
    box.Size = UDim2.new(0, 140, 0, 26)
    box.BackgroundColor3 = HubX.Theme.BackgroundAlt
    box.BorderSizePixel = 0
    box.Font = Enum.Font.Gotham
    box.Text = default
    box.PlaceholderText = placeholder
    box.TextSize = 13
    box.TextColor3 = theme.Text
    box.PlaceholderColor3 = theme.Placeholder
    box.ClearTextOnFocus = false
    box.ZIndex = 6
    box.Parent = item

    local boxCorner = Instance.new("UICorner")
    boxCorner.CornerRadius = UDim.new(0, 6)
    boxCorner.Parent = box

    local boxStroke = Instance.new("UIStroke")
    boxStroke.Color = theme.ElementOutline
    boxStroke.Thickness = 1
    boxStroke.Parent = box

    local function fire()
        task.spawn(function()
            pcall(callback, box.Text)
        end)
    end

    box.FocusLost:Connect(function()
        fire()
    end)

    return {
        Set = function(_, v)
            box.Text = tostring(v)
            fire()
        end,
        Get = function()
            return box.Text
        end
    }
end

local function getScreenSize()
    if HubX._gui then
        return HubX._gui.AbsoluteSize
    end
    return Vector2.new(800, 600)
end

-- DROPDOWN (popup + scroll)
function TabMethods:CreateDropdown(opts)
    opts = opts or {}
    local text = opts.Text or "Dropdown"
    local list = opts.List or {}
    local default = opts.Default
    local callback = opts.Callback or function() end
    local theme = HubX.Theme

    local item = createElementBase(self, 46)

    local label = Instance.new("TextLabel")
    label.Name = "Label"
    label.BackgroundTransparency = 1
    label.Size = UDim2.new(1, -160, 1, 0)
    label.Font = Enum.Font.Gotham
    label.Text = text
    label.TextSize = 14
    label.TextColor3 = theme.Text
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.ZIndex = 6
    label.Parent = item

    local main = Instance.new("Frame")
    main.Name = "Dropdown"
    main.AnchorPoint = Vector2.new(1, 0.5)
    main.Position = UDim2.new(1, -4, 0.5, 0)
    main.Size = UDim2.new(0, 140, 0, 26)
    main.BackgroundColor3 = theme.BackgroundAlt
    main.BorderSizePixel = 0
    main.ZIndex = 6
    main.Parent = item

    local mainCorner = Instance.new("UICorner")
    mainCorner.CornerRadius = UDim.new(0, 6)
    mainCorner.Parent = main

    local mainStroke = Instance.new("UIStroke")
    mainStroke.Color = theme.ElementOutline
    mainStroke.Thickness = 1
    mainStroke.Parent = main

    local currentLabel = Instance.new("TextLabel")
    currentLabel.Name = "Current"
    currentLabel.BackgroundTransparency = 1
    currentLabel.Position = UDim2.new(0, 8, 0, 0)
    currentLabel.Size = UDim2.new(1, -26, 1, 0)
    currentLabel.Font = Enum.Font.Gotham
    currentLabel.Text = default and tostring(default) or "Select"
    currentLabel.TextSize = 13
    currentLabel.TextColor3 = theme.Text
    currentLabel.TextXAlignment = Enum.TextXAlignment.Left
    currentLabel.ZIndex = 7
    currentLabel.Parent = main

    local arrow = Instance.new("TextLabel")
    arrow.Name = "Arrow"
    arrow.BackgroundTransparency = 1
    arrow.AnchorPoint = Vector2.new(1, 0.5)
    arrow.Position = UDim2.new(1, -6, 0.5, 0)
    arrow.Size = UDim2.new(0, 12, 0, 12)
    arrow.Font = Enum.Font.GothamBold
    arrow.Text = "▼"
    arrow.TextSize = 12
    arrow.TextColor3 = theme.SubText
    arrow.TextXAlignment = Enum.TextXAlignment.Center
    arrow.ZIndex = 7
    arrow.Parent = main

    local button = Instance.new("TextButton")
    button.Name = "Hitbox"
    button.BackgroundTransparency = 1
    button.Size = UDim2.new(1, 0, 1, 0)
    button.Text = ""
    button.ZIndex = 8
    button.Parent = main

    local popupFrame = Instance.new("Frame")
    popupFrame.Name = "DropdownPopup"
    popupFrame.BackgroundTransparency = 1
    popupFrame.Size = UDim2.new(0, 0, 0, 0)
    popupFrame.Visible = false
    popupFrame.ZIndex = 30
    popupFrame.Parent = HubX._popupLayer

    local listHolder = Instance.new("Frame")
    listHolder.Name = "ListHolder"
    listHolder.BackgroundColor3 = theme.BackgroundAlt
    listHolder.BorderSizePixel = 0
    listHolder.Size = UDim2.new(0, 140, 0, 0)
    listHolder.ZIndex = 31
    listHolder.Parent = popupFrame

    local listCorner = Instance.new("UICorner")
    listCorner.CornerRadius = UDim.new(0, 6)
    listCorner.Parent = listHolder

    local listStroke = Instance.new("UIStroke")
    listStroke.Color = theme.ElementOutline
    listStroke.Thickness = 1
    listStroke.Parent = listHolder

    local listScroll = Instance.new("ScrollingFrame")
    listScroll.Name = "ListScroll"
    listScroll.BackgroundTransparency = 1
    listScroll.BorderSizePixel = 0
    listScroll.Size = UDim2.new(1, 0, 1, 0)
    listScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
    listScroll.ScrollBarThickness = 3
    listScroll.ScrollBarImageColor3 = Color3.fromRGB(80, 84, 98)
    listScroll.ZIndex = 32
    listScroll.Parent = listHolder

    local listLayout = Instance.new("UIListLayout")
    listLayout.SortOrder = Enum.SortOrder.LayoutOrder
    listLayout.Padding = UDim.new(0, 2)
    listLayout.Parent = listScroll

    local listPadding = Instance.new("UIPadding")
    listPadding.PaddingTop = UDim.new(0, 4)
    listPadding.PaddingBottom = UDim.new(0, 4)
    listPadding.PaddingLeft = UDim.new(0, 4)
    listPadding.PaddingRight = UDim.new(0, 4)
    listPadding.Parent = listScroll

    listLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        listScroll.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y + 8)
    end)

    local opened = false
    local selected = default

    local function setSelected(val, fire)
        selected = val
        currentLabel.Text = tostring(val)
        if fire then
            task.spawn(function()
                pcall(callback, val)
            end)
        end
    end

    local function refresh()
        for _, child in ipairs(listScroll:GetChildren()) do
            if child:IsA("TextButton") and child.Name == "Item" then
                child:Destroy()
            end
        end

        for _, v in ipairs(list) do
            local btn = Instance.new("TextButton")
            btn.Name = "Item"
            btn.Size = UDim2.new(1, 0, 0, 22)
            btn.BackgroundColor3 = theme.Element
            btn.AutoButtonColor = false
            btn.Text = ""
            btn.ZIndex = 33
            btn.Parent = listScroll

            local btnCorner = Instance.new("UICorner")
            btnCorner.CornerRadius = UDim.new(0, 4)
            btnCorner.Parent = btn

            local lbl = Instance.new("TextLabel")
            lbl.BackgroundTransparency = 1
            lbl.Size = UDim2.new(1, 0, 1, 0)
            lbl.Font = Enum.Font.Gotham
            lbl.Text = tostring(v)
            lbl.TextSize = 13
            lbl.TextColor3 = theme.Text
            lbl.TextXAlignment = Enum.TextXAlignment.Left
            lbl.ZIndex = 34
            lbl.Parent = btn

            local pad = Instance.new("UIPadding")
            pad.PaddingLeft = UDim.new(0, 6)
            pad.Parent = btn

            btn.MouseEnter:Connect(function()
                TweenService:Create(btn, TweenInfo.new(0.12, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
                    BackgroundColor3 = theme.ElementOutline
                }):Play()
            end)

            btn.MouseLeave:Connect(function()
                TweenService:Create(btn, TweenInfo.new(0.12, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
                    BackgroundColor3 = theme.Element
                }):Play()
            end)

            btn.MouseButton1Click:Connect(function()
                setSelected(v, true)
                if opened then
                    opened = false
                    popupFrame.Visible = false
                    arrow.Rotation = 0
                end
            end)
        end

        local totalHeight = listLayout.AbsoluteContentSize.Y + 8
        local maxHeight = 160
        local finalHeight = math.min(totalHeight, maxHeight)
        listHolder.Size = UDim2.new(0, 140, 0, finalHeight)
    end

    refresh()

    local function open()
        if opened then return end
        opened = true

        local absPos = main.AbsolutePosition
        local absSize = main.AbsoluteSize
        local screenSize = getScreenSize()

        local popupX = absPos.X
        local popupY = absPos.Y + absSize.Y + 2
        local popupWidth = 140
        local popupHeight = listHolder.Size.Y.Offset

        if popupY + popupHeight > screenSize.Y - 10 then
            popupY = absPos.Y - popupHeight - 2
        end

        popupFrame.Position = UDim2.fromOffset(popupX, popupY)
        popupFrame.Size = UDim2.fromOffset(popupWidth, popupHeight)
        listHolder.Position = UDim2.new(0, 0, 0, 0)

        popupFrame.Visible = true
        TweenService:Create(listHolder, TweenInfo.new(0.18, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
            BackgroundTransparency = 0
        }):Play()
        TweenService:Create(arrow, TweenInfo.new(0.18, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
            Rotation = 180
        }):Play()
    end

    local function close()
        if not opened then return end
        opened = false
        popupFrame.Visible = false
        arrow.Rotation = 0
    end

    button.MouseButton1Click:Connect(function()
        if opened then
            close()
        else
            open()
        end
    end)

    if default ~= nil then
        task.spawn(function()
            pcall(callback, default)
        end)
    end

    return {
        Set = function(_, v)
            setSelected(v, true)
        end,
        Get = function()
            return selected
        end,
        Refresh = function(_, newList)
            list = newList or {}
            refresh()
        end
    }
end

-- COLOR PICKER (popup)
function TabMethods:CreateColorPicker(opts)
    opts = opts or {}
    local text = opts.Text or "Color"
    local default = opts.Default or Color3.fromRGB(0, 153, 255)
    local callback = opts.Callback or function() end
    local theme = HubX.Theme

    local item = createElementBase(self, 46)

    local label = Instance.new("TextLabel")
    label.Name = "Label"
    label.BackgroundTransparency = 1
    label.Size = UDim2.new(1, -160, 1, 0)
    label.Font = Enum.Font.Gotham
    label.Text = text
    label.TextSize = 14
    label.TextColor3 = theme.Text
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.ZIndex = 6
    label.Parent = item

    local button = Instance.new("TextButton")
    button.Name = "ColorButton"
    button.AnchorPoint = Vector2.new(1, 0.5)
    button.Position = UDim2.new(1, -4, 0.5, 0)
    button.Size = UDim2.new(0, 140, 0, 26)
    button.BackgroundColor3 = theme.BackgroundAlt
    button.AutoButtonColor = false
    button.Text = ""
    button.ZIndex = 6
    button.Parent = item

    local buttonCorner = Instance.new("UICorner")
    buttonCorner.CornerRadius = UDim.new(0, 6)
    buttonCorner.Parent = button

    local buttonStroke = Instance.new("UIStroke")
    buttonStroke.Color = theme.ElementOutline
    buttonStroke.Thickness = 1
    buttonStroke.Parent = button

    local preview = Instance.new("Frame")
    preview.Name = "Preview"
    preview.AnchorPoint = Vector2.new(0, 0.5)
    preview.Position = UDim2.new(0, 4, 0.5, 0)
    preview.Size = UDim2.new(0, 32, 0, 18)
    preview.BackgroundColor3 = default
    preview.BorderSizePixel = 0
    preview.ZIndex = 7
    preview.Parent = button

    local previewCorner = Instance.new("UICorner")
    previewCorner.CornerRadius = UDim.new(0, 4)
    previewCorner.Parent = preview

    local hexLabel = Instance.new("TextLabel")
    hexLabel.Name = "Hex"
    hexLabel.BackgroundTransparency = 1
    hexLabel.Position = UDim2.new(0, 42, 0, 0)
    hexLabel.Size = UDim2.new(1, -50, 1, 0)
    hexLabel.Font = Enum.Font.Gotham
    hexLabel.TextSize = 13
    hexLabel.TextColor3 = theme.Text
    hexLabel.TextXAlignment = Enum.TextXAlignment.Left
    hexLabel.ZIndex = 7
    hexLabel.Parent = button

    local function colorToHex(c)
        local r = math.floor(c.R * 255 + 0.5)
        local g = math.floor(c.G * 255 + 0.5)
        local b = math.floor(c.B * 255 + 0.5)
        return string.format("#%02X%02X%02X", r, g, b)
    end

    local currentColor = default
    hexLabel.Text = colorToHex(currentColor)

    local popupFrame = Instance.new("Frame")
    popupFrame.Name = "ColorPopup"
    popupFrame.BackgroundTransparency = 1
    popupFrame.Size = UDim2.new(0, 0, 0, 0)
    popupFrame.Visible = false
    popupFrame.ZIndex = 30
    popupFrame.Parent = HubX._popupLayer

    local palette = Instance.new("Frame")
    palette.Name = "Palette"
    palette.BackgroundColor3 = theme.BackgroundAlt
    palette.BorderSizePixel = 0
    palette.Size = UDim2.new(0, 180, 0, 26)
    palette.ZIndex = 31
    palette.Parent = popupFrame

    local paletteCorner = Instance.new("UICorner")
    paletteCorner.CornerRadius = UDim.new(0, 6)
    paletteCorner.Parent = palette

    local paletteStroke = Instance.new("UIStroke")
    paletteStroke.Color = theme.ElementOutline
    paletteStroke.Thickness = 1
    paletteStroke.Parent = palette

    local gradient = Instance.new("UIGradient")
    gradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 0, 0)),
        ColorSequenceKeypoint.new(0.17, Color3.fromRGB(255, 255, 0)),
        ColorSequenceKeypoint.new(0.33, Color3.fromRGB(0, 255, 0)),
        ColorSequenceKeypoint.new(0.50, Color3.fromRGB(0, 255, 255)),
        ColorSequenceKeypoint.new(0.67, Color3.fromRGB(0, 0, 255)),
        ColorSequenceKeypoint.new(0.83, Color3.fromRGB(255, 0, 255)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 0, 0)),
    })
    gradient.Rotation = 0
    gradient.Parent = palette

    local selector = Instance.new("Frame")
    selector.Name = "Selector"
    selector.AnchorPoint = Vector2.new(0.5, 0.5)
    selector.Size = UDim2.new(0, 4, 1.2, 0)
    selector.Position = UDim2.new(0, 0, 0.5, 0)
    selector.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    selector.BorderSizePixel = 0
    selector.ZIndex = 32
    selector.Parent = palette

    local selectorCorner = Instance.new("UICorner")
    selectorCorner.CornerRadius = UDim.new(0, 2)
    selectorCorner.Parent = selector

    local opened = false

    local function setColorFromPercent(p, fire)
        p = math.clamp(p, 0, 1)
        local color = Color3.fromHSV(p, 1, 1)
        currentColor = color
        preview.BackgroundColor3 = color
        hexLabel.Text = colorToHex(color)
        selector.Position = UDim2.new(p, 0, 0.5, 0)
        if fire then
            task.spawn(function()
                pcall(callback, color)
            end)
        end
    end

    local function open()
        if opened then return end
        opened = true

        local absPos = button.AbsolutePosition
        local absSize = button.AbsoluteSize
        local screenSize = getScreenSize()

        local popupX = absPos.X
        local popupY = absPos.Y + absSize.Y + 2
        local popupWidth = 180
        local popupHeight = 26

        if popupY + popupHeight > screenSize.Y - 10 then
            popupY = absPos.Y - popupHeight - 2
        end

        popupFrame.Position = UDim2.fromOffset(popupX, popupY)
        popupFrame.Size = UDim2.fromOffset(popupWidth, popupHeight)
        palette.Position = UDim2.new(0, 0, 0, 0)

        popupFrame.Visible = true
    end

    local function close()
        if not opened then return end
        opened = false
        popupFrame.Visible = false
    end

    button.MouseButton1Click:Connect(function()
        if opened then
            close()
        else
            open()
        end
    end)

    local dragging = false

    local function updateFromInput(input, fire)
        local rel = (input.Position.X - palette.AbsolutePosition.X) / palette.AbsoluteSize.X
        setColorFromPercent(rel, fire)
    end

    palette.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1
        or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            updateFromInput(input, true)
        end
    end)

    palette.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1
        or input.UserInputType == Enum.UserInputType.Touch then
            dragging = false
        end
    end)

    UIS.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement
        or input.UserInputType == Enum.UserInputType.Touch) then
            updateFromInput(input, true)
        end
    end)

    task.spawn(function()
        pcall(callback, currentColor)
    end)

    return {
        Set = function(_, c)
            if typeof(c) == "Color3" then
                currentColor = c
                preview.BackgroundColor3 = c
                hexLabel.Text = colorToHex(c)
                local h = c:ToHSV()
                selector.Position = UDim2.new(h, 0, 0.5, 0)
                task.spawn(function()
                    pcall(callback, c)
                end)
            end
        end,
        Get = function()
            return currentColor
        end
    }
end

-- PLAYER SELECTOR
function TabMethods:CreatePlayerSelector(opts)
    opts = opts or {}
    local text = opts.Text or "Player"
    local callback = opts.Callback or function() end

    local currentPlayer = nil
    local playerNames = {}

    local function rebuildList()
        playerNames = {}
        for _, plr in ipairs(Players:GetPlayers()) do
            table.insert(playerNames, plr.Name)
        end
    end

    rebuildList()

    local dropdown = self:CreateDropdown({
        Text = text,
        List = playerNames,
        Callback = function(name)
            local plr
            for _, p in ipairs(Players:GetPlayers()) do
                if p.Name == name then
                    plr = p
                    break
                end
            end
            currentPlayer = plr
            task.spawn(function()
                pcall(callback, plr)
            end)
        end
    })

    Players.PlayerAdded:Connect(function()
        rebuildList()
        dropdown:Refresh(playerNames)
    end)

    Players.PlayerRemoving:Connect(function(removing)
        rebuildList()
        dropdown:Refresh(playerNames)
        if currentPlayer == removing then
            currentPlayer = nil
        end
    end)

    return {
        Get = function()
            return currentPlayer
        end,
        Refresh = function()
            rebuildList()
            dropdown:Refresh(playerNames)
        end
    }
end

return HubX
